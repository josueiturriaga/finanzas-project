{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billetera Diaria</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        /* --- CORE CONFIG --- */
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b;
            --primary: #38bdf8; --secondary: #818cf8;
            --gold: #fbbf24; --danger: #f87171; --success: #34d399;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
        }

        html { background-color: var(--bg-body); }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; }

        /* --- HEADER --- */
        .main-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 25px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 30px; }
        .logo-area h1 { margin: 0; font-weight: 700; font-size: 1.5rem; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-link { text-decoration: none; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .btn-logout { background: rgba(248, 113, 113, 0.1); color: var(--danger); border: none; padding: 8px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: var(--danger); color: white; }

        .content-container { max-width: 1200px; margin: 0 auto; padding: 0 30px 50px 30px; }

        /* --- ZONA DE CONTROLES --- */
        .controls-area { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .buttons-group { display: flex; gap: 15px; }

        .btn-add { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: #0f172a; padding: 12px 24px; border-radius: 12px; text-decoration: none; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 20px rgba(56, 189, 248, 0.3); transition: transform 0.2s; }
        .btn-add:hover { transform: translateY(-3px); }

        .btn-transfer { background: rgba(251, 191, 36, 0.1); color: var(--gold); border: 1px solid var(--gold); padding: 12px 24px; border-radius: 12px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-transfer:hover { background: var(--gold); color: #0f172a; }

        .filter-bar { background: var(--bg-card); padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; gap: 15px; align-items: center; }
        .filter-select { background: var(--bg-body); color: white; border: 1px solid #334155; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; }
        .btn-filter { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-filter:hover { background: var(--primary); color: #0f172a; }
        .btn-clear { text-decoration: none; color: var(--text-muted); font-size: 0.9rem; margin-left: 5px; }
        .btn-clear:hover { color: white; }

        /* --- DASHBOARD --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.03); position: relative; overflow: hidden; }
        .card h3 { margin: 0 0 10px 0; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .card h2 { margin: 0; font-size: 2.2rem; font-weight: 700; }
        .text-gradient-cyan { background: linear-gradient(to right, #22d3ee, #38bdf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .text-pink { color: #f472b6; }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; align-items: center; }

        /* --- ESTILOS DEL HISTORIAL Y ANIMACIÓN --- */
        .history-trigger {
            background: var(--bg-card);
            padding: 20px 25px;
            border-radius: 20px; /* Redondeado cuando está cerrado */
            border: 1px solid rgba(255,255,255,0.03);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
            /* Transición suave para el borde cuando se pega a la tabla */
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1); 
            position: relative; z-index: 2;
        }
        
        .history-trigger:hover { background: rgba(255,255,255,0.05); }

        /* Clase activa: quita el borde inferior para "pegarse" */
        .history-trigger.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: transparent; /* Hacemos transparente el borde de unión */
        }
        
        .trigger-left { display: flex; align-items: center; gap: 12px; }
        .count-badge { background: #334155; font-size: 0.8rem; padding: 3px 10px; border-radius: 10px; color: #cbd5e1; font-weight: 600; }
        .arrow-icon { transition: transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1); color: var(--gold); font-size: 1.1rem; }
        .rotated { transform: rotate(180deg); }

        /* --- [NUEVO] ESTRUCTURA DE ANIMACIÓN (Acordeón) --- */
        /* 1. El envoltorio exterior maneja la altura (grid trick) */
        .accordion-wrapper {
            display: grid;
            grid-template-rows: 0fr; /* Cerrado por defecto (altura 0) */
            transition: grid-template-rows 0.5s cubic-bezier(0.4, 0.0, 0.2, 1); /* Animación 'sedosa' */
        }
        
        /* Estado abierto */
        .accordion-wrapper.is-open {
            grid-template-rows: 1fr; /* Abierto (altura del contenido) */
        }

        /* 2. El envoltorio interior oculta el desbordamiento */
        .accordion-content {
            overflow: hidden;
        }

        /* 3. La tabla en sí (Modified) */
        .table-wrapper { 
            background: var(--bg-card); 
            border-radius: 0 0 20px 20px; /* Redondeado solo abajo */
            padding: 5px; 
            border: 1px solid rgba(255,255,255,0.03); 
            border-top: none; /* Pegado al header */
            margin-top: 0;
            
            /* Animación de entrada (Fade In y Deslizamiento) */
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            /* Un pequeño retraso para que empiece después de que se abre un poco el acordeón */
            transition-delay: 0.1s; 
        }
        
        /* Cuando el acordeón está abierto, la tabla aparece */
        .accordion-wrapper.is-open .table-wrapper {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Estilos de la tabla (igual que antes) */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 20px 25px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        td { padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.02); vertical-align: middle; }
        .amount-badge { font-weight: 700; } .income { color: var(--success); } .expense { color: var(--danger); }
        .actions { display: flex; gap: 10px; } .btn-icon { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: 0.2s; font-size: 0.9rem; } .edit { background: rgba(253, 224, 71, 0.1); color: #facc15; } .delete { background: rgba(248, 113, 113, 0.1); color: #f87171; }

        @media (max-width: 900px) {
            .dashboard-grid, .charts-row { grid-template-columns: 1fr; }
            .controls-area { flex-direction: column; align-items: stretch; }
            .buttons-group { flex-direction: column; }
            .btn-add, .btn-transfer { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-area">
            <a href="{% url 'menu' %}" class="logo-link">
                <h1><i class="fa-solid fa-wallet"></i> Vitality Finanzas</h1>
            </a>
        </div>
        <div class="user-info">
            <span style="color:#94a3b8"><i class="fa-regular fa-user"></i> {{ user.username }}</span>
            <form action="{% url 'logout' %}" method="post">{% csrf_token %}
                <button type="submit" class="btn-logout"><i class="fa-solid fa-power-off"></i></button>
            </form>
        </div>
    </header>

    <div class="content-container">
        
        <div class="controls-area">
            <div class="buttons-group">
                <a href="{% url 'agregar_transaccion' %}" class="btn-add">
                    <i class="fa-solid fa-plus"></i> Nuevo Movimiento
                </a>
                <a href="{% url 'transferir' %}" class="btn-transfer">
                    <i class="fa-solid fa-piggy-bank"></i> Mover a Ahorro
                </a>
            </div>

            <form method="get" class="filter-bar">
                <i class="fa-solid fa-filter" style="color: var(--primary);"></i>
                <select name="mes" class="filter-select">
                    <option value="1" {% if mes_actual == 1 %}selected{% endif %}>Enero</option>
                    <option value="2" {% if mes_actual == 2 %}selected{% endif %}>Febrero</option>
                    <option value="3" {% if mes_actual == 3 %}selected{% endif %}>Marzo</option>
                    <option value="4" {% if mes_actual == 4 %}selected{% endif %}>Abril</option>
                    <option value="5" {% if mes_actual == 5 %}selected{% endif %}>Mayo</option>
                    <option value="6" {% if mes_actual == 6 %}selected{% endif %}>Junio</option>
                    <option value="7" {% if mes_actual == 7 %}selected{% endif %}>Julio</option>
                    <option value="8" {% if mes_actual == 8 %}selected{% endif %}>Agosto</option>
                    <option value="9" {% if mes_actual == 9 %}selected{% endif %}>Septiembre</option>
                    <option value="10" {% if mes_actual == 10 %}selected{% endif %}>Octubre</option>
                    <option value="11" {% if mes_actual == 11 %}selected{% endif %}>Noviembre</option>
                    <option value="12" {% if mes_actual == 12 %}selected{% endif %}>Diciembre</option>
                </select>
                <select name="anio" class="filter-select">
                    {% for y in lista_anios %}
                        <option value="{{ y }}" {% if anio_actual == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn-filter">Filtrar</button>
                <a href="{% url 'home' %}" class="btn-clear"><i class="fa-solid fa-xmark"></i></a>
            </form>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Saldo Disponible</h3>
                <h2 class="{% if saldo >= 0 %}text-gradient-cyan{% else %}text-pink{% endif %}">${{ saldo|intcomma }}</h2>
            </div>
            <div class="card">
                <h3>Ingresos</h3>
                <h2 style="color: var(--success);">+${{ ingresos|intcomma }}</h2>
            </div>
            <div class="card">
                <h3>Gastos</h3>
                <h2 style="color: var(--danger);">-${{ gastos|intcomma }}</h2>
            </div>
        </div>

        <div class="charts-row">
            <div class="card">
                <h3>Gastos por Categoría</h3>
                <div class="chart-container"><canvas id="chartGastos"></canvas></div>
            </div>
            <div class="card">
                <h3>Fuentes de Ingreso</h3>
                <div class="chart-container"><canvas id="chartIngresos"></canvas></div>
            </div>
        </div>

        <div class="history-trigger" id="histTrigger" onclick="toggleHistory()">
            <div class="trigger-left">
                <i class="fa-solid fa-clock-rotate-left" style="color: white; font-size: 1.2rem;"></i>
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: white;">Historial Reciente</h3>
                <span class="count-badge">{{ transacciones.count }}</span>
            </div>
            <i class="fa-solid fa-chevron-down arrow-icon" id="historyArrow"></i>
        </div>

        <div class="accordion-wrapper" id="historyAccordion">
            <div class="accordion-content">
                 <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Concepto</th>
                                <th>Categoría</th>
                                <th>Monto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in transacciones %}
                            <tr>
                                <td style="color: #94a3b8;">{{ t.fecha|date:"d M, Y" }}</td>
                                <td>
                                    <div style="font-weight: 600; margin-bottom: 4px;">{{ t.titulo }}</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">{{ t.cuenta|title }}</div>
                                </td>
                                <td><span style="background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; color: #94a3b8;">{{ t.get_categoria_display }}</span></td>
                                <td>
                                    {% if t.tipo == 'ingreso' %}
                                        <span class="amount-badge income">+ ${{ t.monto|intcomma }}</span>
                                    {% else %}
                                        <span class="amount-badge expense">- ${{ t.monto|intcomma }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="actions">
                                        <a href="{% url 'editar_transaccion' t.id %}" class="btn-icon edit"><i class="fa-solid fa-pen"></i></a>
                                        <a href="{% url 'eliminar_transaccion' t.id %}" class="btn-icon delete" onclick="return confirm('¿Seguro?');"><i class="fa-solid fa-trash"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" style="text-align:center; padding: 40px; color: #94a3b8;">No hay movimientos en este periodo.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Lógica de animación actualizada
        function toggleHistory() {
            var accordion = document.getElementById("historyAccordion");
            var arrow = document.getElementById("historyArrow");
            var trigger = document.getElementById("histTrigger");
            
            // Alternamos las clases 'is-open', 'rotated' y 'active'
            accordion.classList.toggle("is-open");
            arrow.classList.toggle("rotated");
            trigger.classList.toggle("active");
        }

        Chart.register(ChartDataLabels);
        const commonOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'Poppins' }, usePointStyle: true } },
                datalabels: {
                    color: '#ffffff', font: { weight: 'bold', size: 12 },
                    formatter: (value, ctx) => {
                        let sum = 0;
                        ctx.chart.data.datasets[0].data.map(d => sum += d);
                        if (value === 0) return "";
                        return (value * 100 / sum).toFixed(0) + "%";
                    }
                }
            },
            cutout: '70%', borderWidth: 0
        };

        const ctxG = document.getElementById('chartGastos').getContext('2d');
        new Chart(ctxG, {
            type: 'doughnut',
            data: {
                labels: JSON.parse('{{ labels_gastos|safe }}'),
                datasets: [{
                    data: JSON.parse('{{ data_gastos|safe }}'),
                    backgroundColor: ['#f87171', '#fbbf24', '#34d399', '#818cf8', '#a78bfa', '#f472b6'],
                    hoverOffset: 10
                }]
            },
            options: commonOptions
        });

        const ctxI = document.getElementById('chartIngresos').getContext('2d');
        new Chart(ctxI, {
            type: 'doughnut',
            data: {
                labels: JSON.parse('{{ labels_ingresos|safe }}'),
                datasets: [{
                    data: JSON.parse('{{ data_ingresos|safe }}'),
                    backgroundColor: ['#34d399', '#22d3ee', '#fbbf24'],
                    hoverOffset: 10
                }]
            },
            options: commonOptions
        });
    </script>

</body>
</html>